\documentclass[en]{../../../eplsummary}

\usepackage{siunitx}
\usepackage{circuitikz}
\usepackage{pgfplots}
%\usepgfplotslibrary{external}
%\tikzexternalize[prefix=external/]
\usepackage{todonotes}

\newcommand*\mean[1]{\overline{#1}}
\newcommand*\equal{=} % hack to have = in tikz

\hypertitle{Analog Electronics}{8}{ELEC}{2532}
{Antoine Paris}
{Denis Flandre}

\part{Electronic noise}
The reference for this section is~\cite[chapter~11]{gray}.
This section assumes the reader is familiar with concepts of variance,
covariance, stationarity, power spectral density, Wiener-Kintchine
theorem, etc. Nevertheless, a very brief summary will be given in the
first section. Please refer to the stochastic processes course otherwise.

\section{Notations and reminders}
Let $x(t)$ be a noisy (i.e. random) signal (a voltage or a current in this case).
The notation $\mean{x^2}$ corresponds to the mean-square variation of $x$
around its average value $\mu_x$
\begin{align*}
    \mean{x^2}  &= \mean{(x-\mu_x)^2} \\
                &= \lim_{T\to\infty}\frac{1}{T}\int_0^T (x-\mu_x)^2
                \mathrm{d}t.
\end{align*}
In other words, $\mean{x^2}$ is the variance of $x$, $\sigma^2_x$.
Note that the second relation only holds if $x$ is ergodic.
In this course, we will often write this as
\begin{equation}
    \mean{x^2} = S(f)\Delta f
    \label{eq:var-psd}
\end{equation}
where $S(f)$ is the power spectral density and $\Delta f$ is the bandwidth
of interest. From the stochastic processes course, you may remember that
the variance can more rigorously be obtained by
\begin{equation}
    \sigma^2 = \int_{-F}^F S(f) \mathrm{d}f
    \label{eq:psd}
\end{equation}
where $S(f)$ is again the power spectral density and the bandwidth of
interest $\Delta f = 2F$. Intuitively, we see that $S(f)$ (expressed either
in either \SI{}{\volt\squared\per\hertz} or \SI{}{\ampere\per\hertz}) gives
how energy is distributed in the frequency domain.
From equation~\eqref{eq:psd}, we can see that equation~\eqref{eq:var-psd}
is only valid if
\begin{enumerate}
    \item $S(f)$ is constant w.r.t the frequency. In this case, $x$ is said to be
    a \emph{white noise} and equation~\eqref{eq:var-psd} is exact. As a reminder,
    the power spectral density is defined as
    the Fourier transform of the auto-covariance function of a weak-sense stationary
    random process. A constant power spectral density thus means that the
    auto-covariance function is a delta, i.e. that the given random process at different
    time instants is uncorrelated ;
    \item The bandwidth of interest $\Delta f$ is small, so that $S(f)$ can be
    considered to be constant on this limited bandwidth. In this case,
    equation~\eqref{eq:var-psd} is only an approximation.
\end{enumerate}
Finally, the corresponding root-mean-square (a.k.a. rms) value is simply given
by
\[ x = \sqrt{\mean{x^2}} = \sqrt{S(f)\Delta f}. \]
Figure~\ref{fig:noise-eq-sin} illustrates equation~\eqref{eq:var-psd} in the
case of a noise current. It also shows why we can approximate noise current
with power spectral density $S(f)$ on a bandwidth $\Delta f$ by a sinusoidal
current generator with rms value $i = \sqrt{S(f)\Delta f}$.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\textwidth]{figures/noise-eq-sin.png}
    \caption{Representation of noise in a bandwidth $\Delta f$ by an
    equivalent sinusoid with the same rms value.}
    \label{fig:noise-eq-sin}
\end{figure}

\section{Sources of noise}
\subsection{Thermal noise}
In conventional resistors, it is due to the \emph{random thermal motion of
the electrons} and is unnafected by the presence or absence of direct
current. In a resistor $R$, thermal noise can be represented by a series
voltage generator of mean square value $\mean{v^2}$ or by a shunt current
generator of mean square value $\mean{i^2}$
\begin{align*}
    \mean{v^2} &= 4kTR\Delta f, \\
    \mean{i^2} &= 4kT\frac{1}{R}\Delta f,
\end{align*}
where $k$ is the Boltzmann's constant, $T$ the absolute temperature (i.e. in
Kelvin) and $\Delta f$ the bandwidth in Hertz. This is illustrated in figure
\ref{fig:thermal-noise-repr}.
From this, it is clear that thermal noise is a \textbf{white noise}. Indeed,
its power spectral density is given either by $4kTR$ in \SI{}{\volt\squared
\per\hertz} or by $4kT\frac{1}{R}$ in \SI{}{\ampere\squared\per\hertz} and
is constant as a function of frequency (this is true up to \SI{1e13}{\hertz}).
Finally, the instantaneous amplitude distribution of thermal noise is
\textbf{Gaussian}.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}
        \draw
        (0,0) to[short, o-] (0,-0.5)
        (0,-0.5) to[R, l=$R$] (0,-2)
        (0,-3.5) to[V, v=$\mean{v^2}$] (0,-2)
        (0,-3.5) to[short, -o] (0,-4)
        
        (5,0) to[short, o-*] (5,-0.5)
        (5,-0.5) to[R, l=$R$] (5,-3.5)
        (5,-3.5) to[short, *-o] (5,-4)
        (5,-0.5) -- (7,-0.5) to[I, i=$\mean{i^2}$] (7,-3.5) -- (5,-3.5)
        ;
    \end{tikzpicture}
    \caption{Representations of thermal noise. The noise voltage (resp. current) is
    represented by a sinusoidal voltage (resp. current) generator with rms value
    $v$ (resp $i$). 
    Note that, because the only quantity of interest is the mean-square value,
    the polarity of the sources doesn't matter.}
    \label{fig:thermal-noise-repr}
\end{figure}

\subsection{Shot noise}
Shot noise is always associated with a direct-current flow and is present in
diodes, MOS transistors and bipolar transistors (i.e. devices for which
a potential barrier across a junction exists). The passage of each carrier
across the junction can be modeled as a random event (which depends on
carrier's energy, direction, etc). The external current is thus composed of
a large number of random independent current pulses. Noting $I_J$ the average
current across the junction, the noise current has a mean square given by
\[ \mean{i^2} = 2qI_J\Delta f \]
where $q$ is the electronic charge. As for thermal noise, this is a
\textbf{white noise} with a \textbf{Gaussian} amplitude distribution.
A small-signal model of a diode including the effect of shot noise is
illustrated in figure~\ref{fig:shot-noise-diode-repr}.
Finally, shot noise is non-correlated with thermal noise. Because shot noise
and thermal noise are both Gaussian, this means that they are independent.

%TODO: why polarity of the source doesn't matter
\begin{figure}[ht]
    \centering
    \begin{tikzpicture}
        \draw
        (2,0) to[short, o-] (2,-0.5)
        (2,-0.5) to[D, i=$I_D$] (2,-2.5)
        (2,-2.5) to[short, -o] (2,-3)
        
        (5,0) -- (8,0) to[I, i=$\mean{i^2}\equal2qI_D\Delta f$] (8,-3)
        (8,-3) -- (5,-3) to[R, l=$r_d\equal\frac{kT}{qI_D}$] (5,0)
        ;
    \end{tikzpicture}
    \caption{Diode small signal model including the effect of shot noise.
    Note that the small signal resistance $r_d$ of the diode is not an actual
    resistance (i.e. that's just a model of the diode). As such, it is not
    a source of thermal noise.}
    \label{fig:shot-noise-diode-repr}
\end{figure}

\subsection{Flicker noise}
Flicker noise (also called pink noise, or $1/f$ noise) is a type of noise
found in all active devices, as well as in some discrete passive elements
such as carbon resistors. The origins of flicker noise are varied, but it is
caused mainly by traps associated with contamination and crystal defects.
Flicker noise is always associated with a flow of direct current, the noise
current has a mean square given by
\[ \mean{i^2} = K_1\frac{I^a}{f^b}\Delta f \]
where $\Delta f$ is a small bandwidth around $f$\footnote{Indeed, remember
the discussion about equation~\eqref{eq:var-psd}.}, $I$ is the direct current,
$K_1$, $a$ and $b \approx 1$ are technology parameters.
At the opposite of thermal noise and shot noise, flicker noise is \textbf{not
white} (hence the name pink) and often has a \textbf{non-Gaussian} amplitude
distribution.

%TODO: might be better in a table in fact...
\subsection{Summary}
A summary of the different noise sources is given in
figure~\ref{fig:noise-summary}.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[level distance=2cm,
        level 1/.style = {sibling distance = 0.4\textwidth},
        every node/.style = {shape=rectangle, rounded corners,
        draw, align=center,
        top color=white, bottom color=gray!20}]

        \node {Noise sources}
            child { node {\textbf{Thermal noise}\\
            Brownian movement of\\
            charges in conductors\\
            $\mean{v^2} = 4kTR\Delta f$\\
            White and Gaussian}  }
            child { node {\textbf{Shot noise}\\
            Random passage of\\
            carriers across a junction\\
            $\mean{i^2} = 2qI_J\Delta f$\\
            White and Gaussian} }
            child { node {\textbf{Flicker noise} ($1/f$)\\
            Random carriers capture/release\\
            by traps\\
            $\mean{i^2} = K_1\frac{I^a}{f^b}\Delta f$\\
            Colored, often non Gaussian} };    
    \end{tikzpicture}
    \caption{Summary of the different noise sources.}
    \label{fig:noise-summary}
\end{figure}

\section{Noise models of Integrated-Circuit Components}
\subsection{Resistors}
Monolithic and thin-film resistors display thermal noise. This has already
been illustrated in figure~\ref{fig:thermal-noise-repr}.

\subsection{Capacitors and inductors}
There are \emph{no sources of noise} in \emph{ideal} capacitors or
inductors. In practice, however, real components have parasitic resistances
that does display thermal noise.

\subsection{Junction Diode}
A small-signal model of the diode that includes the effect of shot noise was
already given in figure~\ref{fig:shot-noise-diode-repr}. This one, however,
does not take into account neither the series parasitic resistance of the
diode (which will display thermal noise) or flicker noise. A more complete
model is given in figure~\ref{fig:diode-noise-model}.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}
        \draw 
        (1.5, 3.3) to[short, o-] (1.5, 3) 
        (1.5, 3) to[V, v=$\mean{v^2_s}\equal4kTr_s\Delta f$] (1.5, 1.5)
        (1.5, 1.5) to[R, l=$r_s$] (1.5, 0) to[short, -*] (1.5, 0)
        (0,0) -- (3,0) to[I, i=$\mean{i^2}\equal2qI_D\Delta f
        + K\frac{I_D^a}{f^b}\Delta f$] (3,-3)
        (3,-3) -- (0,-3) to[R, l=$r_d\equal\frac{kT}{qI_D}$] (0,0)
        (1.5, -3) to[short, -o] (1.5, -3.3)
        ;
    \end{tikzpicture}
    \caption{Complete diode small-signal model equivalent circuit with noise
    sources.}
    \label{fig:diode-noise-model}
\end{figure}

Again, it is important to distinguish resistances that really exist from resistances that constitute
the model of the circuit component. In this case for instance, the parasitic series resistance
$r_s$ really exists, and as such exhibits thermal noise. The diode small signal resistance $r_d$ however
does not really exists, its purpose is purely to model the small-signal behaviour of the diode. As $r_d$
does not really exists, it obviously does not produce any kind of noise.

\subsection{Bipolar transistor}
A small-signal model equivalent circuit with noise sources for a bipolar transistor
is given in figure~\ref{fig:bjt-noise-model}. This model contains the following
noise sources:
\begin{enumerate}
	\item $\mean{v^2_b}$: thermal noise associated with the
	parasitic resistance of the base connection
	\[ \mean{v^2_b} = 4kTr_b\Delta f. \]
	\item $\mean{i^2_c}$: random transit time through the base (i.e. shot noise)
	\[ \mean{i^2_c} = 2qI_C\Delta f. \]
	\item $\mean{i^2_b}$: random carrier injection in emitter (i.e shot noise).
	Experimentally, it can also be seen that the base current is sensitive to
	flicker noise and telegraph noise (neglected in this course)
	\[ \mean{i^2_b} = 2qI_b\Delta f + K_1\frac{I_b^a}{f^b}\Delta f. \]
\end{enumerate}

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}
        \draw
        (0, 2) to[short, o-, l=$B$] (0, 2) to[R, l=$r_b$] (2, 2)
        (2, 2) to[V, v=$\mean{v_b^2}$] (4, 2)
        (0, 0) to[short, o-] (0, 0) -- (4, 0)
        (4, 0) to[I, i=$\mean{i_b^2}$] (4, 2)
        (4, 2) -- (5.5, 2) to[R, l_=$r_\pi$] (5.5, 0) -- (4, 0)
        (5.5, 2) -- (7, 2) to[C, l_=$C_\pi$, v^=$v_\pi$] (7, 0) -- (5.5, 0)
        (7, 0) to[short, -, l_=$E$] (9, 0)
        (9, 2) to[I, i=$g_mv_\pi$] (9, 0)
        (9, 2) -- (11, 2) to[R, l=$r_o$] (11, 0) -- (9, 0)
        (11, 0) -- (13, 0) to[I, i=$\mean{i_c^2}$] (13, 2) -- (11, 2)
        (13, 0) to[short, -o] (13.5, 0)
        (13, 2) to[short, -o, l=$C$] (13.5, 2)
        ;
    \end{tikzpicture}
    \caption{Bipolar transistor small-signal equivalent circuit
    with noise sources. Again, because $r_\pi$ and $r_o$ are not real resistance
    (i.e. they are there to model the physical behaviour of the device), they do not
    display thermal noise.}
    \label{fig:bjt-noise-model}
\end{figure}

The power spectral density associated with the noise source $\mean{i_b^2}$ (i.e
$\mean{i_b^2}/\Delta f$) is illustrated in figure~\ref{fig:corner-frequency}.
\begin{figure}
	\centering
	\includegraphics[width=0.6\textwidth]{figures/corner-frequency.png}
	\caption{Power spectral density of the base-current noise generator in a
	bipolar transistor. At low frequency, $1/f$ noise dominates while at higher
	frequency, shot noise dominates. $f_a$ is called the flicker noise
	\emph{corner} frequency.}
	\label{fig:corner-frequency}
\end{figure}

\subsection{MOS transistor}
A small-signal model equivalent circuit with noise sources for the MOS transistor
is given in figure~\ref{fig:mos-noise-model}. This model contains the following
noise sources:
\begin{enumerate}
    \item $\mean{i^2_g}$ : contains the shot noise generated by the gate leakage current
    \[ \mean{i^2_g} = 2qI_G\Delta f. \]
    At higher frequencies, another noise component due to a random component of the
    gate-to-channel voltage caused by thermal noise along the channel. This generates
    a noisy ac gate current $i_g$ with mean-squared value
    \[ \mean{i^2_g} = \frac{16}{15}kT\omega^2C^2_{gs}\Delta f. \]
    \item $\mean{i^2_d}$ : since the channel material is resistive, it exhibits thermal
    noise, which is a major source of noise in MOS transistors. Moreover, because MOS
    transistors conduct current near the gate-oxyde interface where surface states acts
    as traps that capture and release current carries: this generates flicker noise
    \[
        \mean{i^2_d} = 4kT\left(\frac{2}{3}g_m\right)\Delta f + K\frac{I_D^a}{f^b}\Delta f
    \]
    where $\frac{2}{3}g_m$ models the channel resistance.
\end{enumerate}

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}
        \draw
        (0, 2) to[short, o-, l=$G$] (1, 2)
        (0, 0) to[short, o-] (1, 0) to[I, i=$\mean{i^2_g}$] (1,2)
        (1, 2) -- (3, 2) to[C, l_=$C_{gs}$, v^=$v_{gs}$] (3, 0) -- (1, 0)
        (3, 2) to[C, l^=$C_{gd}$] (5, 2) to[I, i=$g_mv_{gs}$] (5, 0)
        (5, 0) to[short, -, l^=$S$] (3, 0)
        (5, 2) -- (7, 2) to[R, l=$r_o$] (7, 0) -- (5, 0)
        (7, 0) -- (9, 0) to[I, i=$\mean{i^2_d}$] (9, 2) -- (7, 2)
        (9, 0) to[short, -o] (10, 0)
        (9, 2) to[short, -o, l^=$D$] (10, 2)
        ;
    \end{tikzpicture}
    \caption{The MOS transistor small-signal equivalent circuit
    with noise sources.}
    \label{fig:mos-noise-model}
\end{figure}

\section{Circuit noise calculations}
\subsection{Superposition}
When two sources of voltage noises are in series, they can be grouped
in a equivalent source of voltage noise $\mean{v^2_e}$ as illustrated
in figure~\ref{fig:superposition-voltage}.

\begin{figure}
    \centering
    \begin{tikzpicture}
        \draw
        (0,0) to[short, o-] (0,-0.5)
        (0,-2) to[V, v=$\mean{v_1^2}$] (0,-0.5)
        (0,-3.5) to[V, v=$\mean{v_2^2}$] (0,-2)
        (0,-3.5) to[short, -o] (0,-4)
        
        (2,-2.5) node[label=$\to$]{}
        
        (4,0) to[short, o-] (4,-0.5)
        (4,-3.5) to[V, v=$\mean{v_e^2}$] (4,-0.5)
        (4,-3.5) to[short, -o] (4,-4)
        ;
    \end{tikzpicture}
    \caption{Superposition principle for noise voltage generators. A similar
    principle applies for noise current generators.}
    \label{fig:superposition-voltage}
\end{figure}
The relation between $\mean{v^2_e}$ and $\mean{v_1^2}$ and $\mean{v_2^2}$
depends on the relation between $v_1$ and $v_2$.

\begin{itemize}
    \item Non-correlated sources:
    \[ \mean{v^2_e} = \mean{v^2_1} + \mean{v^2_1} \]

    \item Fully correlated sources:
    \[ \mean{v^2_e} = \mean{(v_1+v_2)^2} \]

    \item Partially correlated sources:
    let $v_2 = v_{22} + v_{21}$ where $v_{22}$ is non-correlated with $v_1$
    and $v_{21}$ is fully correlated with $v_1$. In this case,
    \[ \mean{v^2_e} = \mean{(v_1 + v_{21})^2} + \mean{v^2_{22}}. \]
\end{itemize}

\subsection{Output noise}
Here are the steps involved in the computation of the total output noise
\begin{enumerate}
    \item Draw the small-signal equivalent circuit with noise sources ;
    \item Ignore the external input signal $v_i$ so that the output signal
    $v_o$ is due to noise generators only ;
    \item Apply the superposition principle and consider each noise source at
    a time. Perform the calculation as if each noise source were a sinusoid with
    rms value equal to that of the noise source being considered ;
    \item Combine every noise sources as explained in the previous section (i.e.,
    depending on their independence).
\end{enumerate}
A complete example can be found in~\cite[section~11.4.1]{gray}.

\subsection{Equivalent input noise and the minimum detectable signal}
\todo[inline]{This section could be improved. One idea would be to use the
complete example of the slides to explain concepts with an example. Also
need to define SNR, noise figure, noise temperature.}
The previous section showed us how to compute the output noise. The significance
of the noise performance of a circuit is, however, the limitation it places on
the smallest input signal the circuit can handle before the noise degrades the
quality of the output signal. For this reason, the noise performance is usually
expressed in terms of an equivalent input noise signal, which gives the same output
noise as the circuit under consideration.
The situation is illustrated in figure~\ref{fig:eq-input-noise}. The need for both
an equivalent input noise voltage generator and an equivalent input noise current
generator to represent the noise performance of the circuit for any source resistance
can be appreciated as follows. If $R_S = 0$, then $\mean{i^2_i}$ is shorted out, and
since the original circuit will still show output noise in general, we need an
equivalent input noise voltage $\mean{v^2_i}$ to represent this behavior. Similarly,,
if $R_S \to\infty$, then $\mean{v^2_i}$ cannot produce output noise, and since the
original circuit will still show output noise in general, we need an equivalent
input noise current $\mean{i^2_i}$ to represent this behavior.

\paragraph{Method}
In both cases, the output of both circuits (i.e. the original one and the one with
equivalent input noise generators) must be short-circuited.
\begin{enumerate}
    \item To obtain $\mean{v_i^2}$ : short-circuit the input of both circuits
    (as discussed above, this has for effect to remove the input noise current
    generator $\mean{i_i^2}$ effect) and equate $i_o$ in each case to obtain $v_i$.
    \item To obtain $\mean{i_i^2}$ : let open-circuited the input of both
    circuits (removing the input noise voltage generator $\mean{v_i^2}$ effect).
\end{enumerate}

Examples can be found in~\cite[sections~11.5.1-2]{gray} or in the slides.

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{figures/eq-input-noise.png}
    \caption{Representation of a noise in a two-port network equivalent input
    voltage and current generators.}
    \label{fig:eq-input-noise}
\end{figure}

\begin{mydef}[Minimum detectable signal]
    The minimum detectable signal (abbreviated MDS) can be taken as equal to
    the equivalent input noise voltage in the passband of the circuit under
    consideration.
\end{mydef}

\todo[inline]{Noise bandwidth}

\part{Active filters}
The reference for this part is~\cite[chapter~11]{sedra}.
\section{First-order filters}
\subsection{Low-pass filter}
The voltage (or current) transfer function of a first-order low-pass
filter is given by
\[ H(\Omega) = \frac{H_0}{1+j\Omega} \]
where $H_0$ is the DC gain (i.e. $H(0) = H_0$) and $\Omega = \frac{\omega}{
\omega_c}$ is the pulsation normalized by the cut-off frequency $\omega_c$. The
power transfer function is then simply given by $|H(\Omega)|^2$.
\subsection{High-pass filter}
The voltage (or current) transfer function of a first-order high-pass
filter is given by
\[ H(\Omega) = H_0\frac{j\Omega}{1+j\Omega}. \]
Note that in this case $H_0$ is the high frequency gain.

\subsection{Implementation}
A first-order low-pass filter can be implemented by a simple circuit illustrated
in figure~\ref{fig:1st-order-lp}. The corresponding voltage transfer function
is given by
\[ H(\omega) = \frac{v_{out}}{v_{in}} = \left(1+\frac{R_2}{R_1}\right)
\frac{1}{1+j\omega RC}.\]
To obtain a first-order high-pass filter, one simply needs to switch $R$ and $C$
on the schematic of figure~\ref{fig:1st-order-lp}. By identification with the
canonical form of a first-order low-pass filter, we find
\begin{align*}
    H_0 &= 1+\frac{R_2}{R_1} &
    \omega_c &= \frac{1}{RC}.
\end{align*}

\begin{figure}
    \centering
    \begin{tikzpicture}
        \draw
        (4,0.5) node [op amp] (opamp) {}
        (0,0) node [left] {$v_{in}$} to [R, l=$R$, o-] (opamp.+)
        -- (opamp.+) to [C, l_=$C$, *-] ($(opamp.+)+(0,-1.7)$) node [ground] {} 
        (opamp.-) -| (2.5,2)
        (2.5,2) to [R, l_=$R_1$, *-] (0, 2) node [ground] {}
        (2.5,2) to [R, l=$R_2$] (4.5,2)
        (opamp.out) |- (4.5, 2)
        (opamp.out) to[short, -o] ($(opamp.out)+(0.5,0)$) node [right] {$v_{out}$}
        ;
    \end{tikzpicture}
    \caption{Implementation of a first-order low-pass filter.}
    \label{fig:1st-order-lp}
\end{figure}

\section{Second-order filters}
The voltage (or current) transfer function of a second-order low-pass filter is given by
\[ H(\Omega) = \frac{H_0}{1+2\zeta(j\Omega) + (j\Omega)^2} \]
where $H_0$ is again the static gain, $\zeta$ is the damping factor and $\Omega
= \frac{\omega}{\omega_n}$ is the pulsation normalized by the undamped natural pulsation
$\omega_n$. The meaning of $\zeta$ and $\omega_n$ can be understood by noting that
\[ |H(1)| = \frac{1}{2\zeta} \eqdef Q \]
where $Q$ is what we call the \emph{quality factor} of a filter.
As reminder from the linear control course, the effect of $\zeta$ on the transfer
function as well as on the transient response to a unit step is illustrated in
figures~\ref{fig:zeta-impact-on-magn}, \ref{fig:zeta-impact-on-phase} and
\ref{fig:zeta-impact-on-step-response}. It can be seen from those figures that there
is a trade-off between oscillations and settling time. With a damping ratio too high,
you'll not get any oscillation but the settling time will be high. A damping ratio
around 0.7 is generally a good trade-off.

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/2nd_order_filter_mag.tex}}
    \caption{Impact of the damping ratio $\zeta$ on the magnitude of the transfer
    function.}
    \label{fig:zeta-impact-on-magn}
\end{figure}

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/2nd_order_filter_phase.tex}}
    \caption{Impact of the damping ratio $\zeta$ on the phase of the transfer
    function.}
    \label{fig:zeta-impact-on-phase}
\end{figure}

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/2nd_order_filter_step_response.tex}}
    \caption{Impact of the damping ratio $\zeta$ on the transient reponse to a
    unit step.}
    \label{fig:zeta-impact-on-step-response}
\end{figure}

\subsection{Implementation}
A second-order filter can be implemented using a Sallen \& Key cell. The schematic
of such an implementation is given in figure~\ref{fig:sallen-key}. The analysis
of this circuit, while a bit tedious, is not complicated and leads to the following
results
\begin{align*}
    H_0 &= 1+\frac{R_{D2}}{R_{D1}} \\
    w_n &= \frac{1}{\sqrt{R_1C_1R_2C_2}} \\
    \frac{2\zeta}{\omega_c} &= (1-H_0)R_1C_1 + (R_1+R_2)C_2.
\end{align*}

\begin{figure}
    \centering
    \begin{tikzpicture}
        \draw
        (4,0.5) node [op amp] (opamp) {}
        (-3,0) node [left] {$v_{in}$} to [R, l=$R_1$, o-] (0,0)
        to [R, l=$R_2$] (opamp.+)
        -- (opamp.+) to [C, l_=$C_2$, *-] ($(opamp.+)+(0,-1.7)$) node [ground] {} 
        (opamp.-) -| (2.5,2)
        (2.5,2) to [R, l_=$R_{D1}$, *-] (0, 2) node [ground] {}
        (2.5,2) to [R, l=$R_{D2}$] (4.5,2)
        (opamp.out) |- (4.5, 2)
        (opamp.out) |- (0, -2.5)
        (0, 0) to [C, l_=$C_1$, *-] (0, -2.5)
        (opamp.out) to[short, -o] ($(opamp.out)+(0.5,0)$) node [right] {$v_{out}$}
        ;
    \end{tikzpicture}
    \caption{Implementation of a second-order low-pass filter with a Sallen \&
    Key cell.}
    \label{fig:sallen-key}
\end{figure}

\section{Third-order filters}
Third-order filters can be obtained by adding a $RC$ filter at the output
of a Sallen \& Key cell.

\section{Filter design procedure}
A simplified design procedure could be the following:
\begin{enumerate}
    \item \textbf{Specification}:
        \begin{itemize}
            \item Pattern in the Fourier domain ;
            \item Constraints (number of amplifiers, technology).
        \end{itemize}
    \item \textbf{Approximation}: depending on the pattern specified, choose the type
    of filter (Butterworth, Chebyshev, etc) that fits the best.
    \item \textbf{Factorization}: decompose the transfer function as a product
    of transfer function of order 1 or 2.
    \item \textbf{Realization}:
        \begin{itemize}
            \item Choose a technology ;
            \item Choose an architecture (Sallen \& Key, etc) ;
            \item Compute values of components.
        \end{itemize}
\end{enumerate}

\subsection{Terminology}
A filter is mostly specified by its \emph{passband} and its \emph{stopband}.
In real filters, however, the transition from the passband to the stopband cannot
be infinitely sharp. The steepness of this transition is called the \emph{roll-off}
and is usually measured in \SI{}{\decibel} per decade. 
The \emph{transition band} is defined as the frequency band
where the transition from the passband to the stopband occurs.
In addition, one needs to specify the maximum allowed variation (i.e. ripples)
in the passband, $A_{max}$, and the minimum required stopband attenuation, $A_{min}$.

\section{Reference filters}
\todo[inline]{Group/phase delay of the different filter types.}
The filters presented in this section can be computed easily using the SciPy
Python module or \textsc{Matlab}.

\subsection{Butterworth}
Butterworth filters are characterized by a \textbf{maximally flat 
magnitude within the passband}.
The power transfer function is given by
\[ |H(j\omega)|^2 = \frac{H_0^2}{1+\left(\frac{j\omega}{j\omega_c}\right)^{2n}} \]
where $n$ is the order of the filter, $w_c$ its cutoff frequency (approximately
at -\SI{3}{\decibel}) and $H_0$ its DC gain.
Bode plots for Butterworth filters of orders 1 to 6 are given in
figure~\ref{fig:butterworth}.

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/butterworth.tex}}
    \caption{Butterworth filter bode plot for a cut-off pulsation of
    \SI{1e9}{\radian\per\second}.}
    \label{fig:butterworth}
\end{figure}

\subsection{Chebyshev}
Chebyshev filters are characterized by a steeper transition (i.e. higher roll-off)
than Butterworth filters. The price to pay for this improvement are some
\textbf{ripples} either in the passband (for type 1 filters) or in the stopband
(for type 2 filters). The power transfer function of a type 1 Chebyshev filter
is given by
\[ |H(j\omega)|^2 = \frac{H^2_0}{1+\epsilon^2C^2_n\left(\frac{\omega}{\omega_c}\right)}\]
where $n$ is again the order of the filter, $\epsilon$ is the ripple factor and
$C_n$ is a Chebyshev polynomial of the $n$th order. For a type 2 filter, this
becomes
\[ |H(j\omega)|^2 = H^2_0\frac{\epsilon^2C^2_n\left(\frac{\omega}{\omega_c}\right)}
{1+\epsilon^2C^2_n\left(\frac{\omega}{\omega_c}\right)}. \]
Bode plots for type 1 Chebyshev filters of orders 1 to 6 are given in
figure~\ref{fig:cheby1}.

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/cheby1.tex}}
    \caption{Chebyshev type 1 filter bode plot for a cut-off pulsation
    of \SI{1e9}{\radian\per\second} and peak-to-peak ripples of \SI{10}{\decibel}.}
    \label{fig:cheby1}
\end{figure}

\subsection{Cauer (elliptic)}
Elliptic filters are \textbf{maximally sharp}. This means than no other filter of
equal order can have a faster transition between the passband and the stopband, for
the given values of ripple. The price to pay for this maximum sharpness is ripples
in both the passband and the stopband. The transfer function of Cauer filters is a bit
more complicated, it is given by
\[
    H(j\omega) =
    \begin{cases}
        \frac{H_0}{j\omega+s_0}\prod_{i=1}^{(n-1)/2}\frac{(j\omega)^2 + A_{0i}}
        {(j\omega)^2 + B_{1i}(j\omega) + B_{0i}}, & \text{for}\ n\ \text{odd} \\
        H_0\prod_{i=1}^{n/2}\frac{(j\omega)^2 + A_{0i}}
        {(j\omega)^2 + B_{1i}(j\omega) + B_{0i}}, & \text{for}\ n\ \text{even}.
    \end{cases}
\]
Bode plots for Elliptic filters of orders 1 to 6 are given in
figure~\ref{fig:ellip}.

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/ellip.tex}}
    \caption{Elliptic bode plot for a cut-off pulsation of \SI{1e9}{\radian\per\second}
    , peak-to-peak ripples of \SI{10}{\decibel} and a stopband attenuation of
    \SI{80}{\decibel}.}
    \label{fig:ellip}
\end{figure}

\subsection{Bessel}
Bessel filters are characterized by a \textbf{maximally flat group/phase delay
in the passband} (or equivalently, \textbf{maximally linear phase response}).
Let first define group and phase delays to see what this means.
\begin{mydef}[Group delay]
    Let $H(j\omega)$ be the transfer function of an LTI system, its group delay
    is defined as
    \[ \tau_g(\omega) = -\fdif{\arg\{H(j\omega)\}}{\omega}. \]
\end{mydef}
\begin{mydef}[Phase delay]
    Let $H(j\omega)$ be the transfer function of an LTI system, its group delay
    is defined as
    \[ \tau_\phi(\omega) = -\frac{\arg\{H(j\omega)\}}{\omega}. \]
\end{mydef}
Let's now consider that an LTI system with transfer function $H(j\omega)$ is driven
by a signal of the form
\[ x(t) = a(t)\cos(\omega t + \theta) \]
where $a(t)$ is assumed to be slowly-changing relative to the pulsation $\omega$.
In this case, we can assume $x(t)$ is a sinusoid and write the output of the system
as
\[ y(t) = |H(j\omega)|a(t-\tau_g)\cos(\omega(t-\tau_\phi) + \theta).\]
The impact of the group and phase delays on the output are now directly visible. Ideally,
we would like $\tau_g$ and $\tau_\phi$ to be constant w.r.t the frequency. This is the
case for what we call \emph{linear phase} systems (see the signal processing course).
If it's not the case, this means that all frequency components of the input signal
will not be delayed by the same amount of time, resulting in distortion.
Bessel filters maximize the flatness of the group delay at zero frequency. That's why
they are often used in audio systems. The transfer function of a Bessel low-pass filter
of order $n$ is given by
\[ H(j\omega) = \frac{\theta_n(0)}{\theta_n\left(\frac{\omega}{\omega_c}\right)}\]
where $\theta_n$ is a reverse Bessel polynomials of order $n$.
Bode plots for Bessel filters of orders 1 to 6 are given in
figure~\ref{fig:bessel}.

\begin{figure}
    \centering
    \resizebox{0.75\textwidth}{!}{\input{figures/bessel.tex}}
    \caption{Bessel bode plot for a cut-off pulsation of \SI{1e9}{\radian\per\second}}
    \label{fig:bessel}
\end{figure}

\section{Sensitivity to components values}
\begin{mydef}[Sensitivity]
    The sensitivity of parameter $P$ to a component $C$, noted
    $S^P_C$ is defined as
    \[ S^P_C = \fdif{P}{C}\frac{C}{P}.\]
\end{mydef}

\section{Other implementations}
\subsection{Integrator-based filters}
\subsubsection{Two integrators based filters}
The two-integrator-loop topology allows to realize second-order filters
using two integrators connected in cascade and a feedback loop. They are
particularly interesting because they provide at the same time a low-pass,
an high-pass and a bandpass filter.

\todo[inline]{Tikz circuit of the two-integrator loop filter.}

\subsubsection{Tow-Thomas}
\todo[inline]{Tikz circuit of the Tow-Thomas filter.}

\subsection{Boctor cells}
\todo[inline]{Do we need to discuss this one?}

\subsection{Switched-capacitor filters}
Precise resistance values are not easy to fabricate in integrated circuits. In
addition, large resistance values takes a lot of room on a IC. One idea to make resitor's
production easier in integrated circuits is to use a capacitor together with two
MOS transistors controlled by non-overlapping clocks as a resistor. The principle
is illustrated on figure~\ref{fig:switched-capacitor}.

When the first switch (i.e. driven by $\phi_1$) is closed, the second one (i.e.
driven by $\phi_2$) is open. The charge on the capacitor $C$ is then $Q_1 = Cv_1$.
When the first switch is open and the second one is closed, the charge on the
capacitor $C$ is $Q_2 = Cv_2$. The variation of charges during a time interval
$T_C$ is thus $\Delta Q = C(v_1-v_2)$. The corresponding current is given by
\[ i(t) = \fdif{Q(t)}{t} = \lim_{t\to 0} \frac{\Delta Q}{\delta t}
= \lim_{T_c\to 0} \frac{C(v_1-v_2)}{T_c}. \]
We can thus see that the circuit of figure~\ref{fig:switched-capacitor} is
equivalent, when $T_c\to 0$ (or $f_c\to\infty$), to a resistance given by
\[ R_{eq} = \frac{v_1-v_2}{i(t)} = \frac{T_c}{C} = \frac{1}{f_cC}. \]
This equation remains valid (but becomes an approximation) for $f_c \gg f$
where $f$ is the frequency of $v_i$.

\begin{myrem}
    Note that a switched-capacitor has the effect of \emph{sampling} the
    voltage at its input. We thus need to pay attention to aliasing to 
    avoid, for example, folding noise in our baseband!
\end{myrem}

\begin{figure}[ht]
    \centering
    \begin{tikzpicture} \draw
        (0,0) node[left] {$v_1$} to[ospst=$\phi_1$, o-] (2,0)
        (2,0) to[C, l=$C$] (2,-1.5) node[ground] {}
        (2,0) to[ospst=$\phi_2$, -o] (4,0) node[right] {$v_2$}
        (0,-1.5) to[short, o-o] (4,-1.5)
        ;

        \begin{scope}[xshift=5.5cm, yshift=0cm] \draw
            (0,0.5) node[left] {$\phi_1$}
            [thick] (0,0) -- (1,0) -- (1,1) -- (2,1) -- (2,0) -- (3,0)
            -- (3,1) -- (4,1) -- (4,0) -- (5,0)
            
            (0,-1) node[left] {$\phi_2$}
            [thick] (0,-0.5) -- (1,-0.5) -- (1,-1.5) -- (2,-1.5) -- (2,-0.5) -- (3,-0.5)
            -- (3,-1.5) -- (4,-1.5) -- (4,-0.5) -- (5,-0.5);

            \draw [->] (2,-2) -- (3,-2);
            \draw [->] (2,-2) -- (1,-2);
            \draw (2,-2) node[anchor=north] {$T_c$};
            
            \draw [dotted] (1,-2) -- (1,1);
            \draw [dotted] (3,-2) -- (3,1);
        \end{scope}
    \end{tikzpicture}
    \caption{Basic principle of a switched-capacitor. Switches are usually implemented
    using MOS transistors. The two clocks $\phi_1$ and $\phi_2$ are non-overlapping.}
    \label{fig:switched-capacitor}
\end{figure}

\part{Voltage and current references}
Ideally, we would like voltage and current references to be as independent as
possible from
\begin{enumerate}
    \item the supply voltage $V_{CC}$ ;
    \item the temperature $T$.
\end{enumerate}
This part aims evaluating the performance of different architectures of
voltage and current references.

The reference for this part is~\cite[section~4.4]{gray}.

\section{Current reference}
\subsection{$V_{CC}$ reference}
\subsubsection{Current mirror}
The left part of figure~\ref{fig:current-mirror-widlar} shows an NPN current
mirror. This simple circuit produces a current $I_{OUT}$ given by
\[ I_{OUT} \approx I_{IN} = \frac{V_{CC}-V_{BE,1}}{R}. \]
Let's compute the sensitivity of $I_{OUT}$ to $V_{CC}$. Starting from the
definition of sensitivity, we have
\[ S^{I_{OUT}}_{V_{CC}} = \fpart{I_{OUT}}{V_{CC}}\frac{V_{CC}}{I_{OUT}} = \frac{V_{CC}}
{V_{CC}-V_{BE,1}} \approx 1 \]
where the last step step assumes $V_{CC} \gg V_{BE,1}$. We see that the output
current of the mirror current is strongly dependent from the supply voltage: the
sensitivity to $V_{CC}$ is 100\%. A good current reference should have a sensitivity
to the supply voltage in the order of 1\%.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture} \draw
        (0,0) to[Tnpn, name=q1, mirror, l=$Q_1$] (0,2)
        (q1.C) to[R, l=$R$, i<_=$I_{IN}$] ($(q1.C)+(0,2)$) node[vcc] {$V_{CC}$}
        (q1.E) node[ground] {}
        (q1.B) |- (q1.C)

        (2,0) to[Tnpn, name=q2, l=$Q_2$] (2,2)
        (q2.B) -- (q1.B)
        (q2.E) node[ground] {}
        ($(q2.C)+(0,0.5)$) to[short, i=$I_{OUT}$] (q2.C)

        (6,0) to[Tnpn, name=r1, mirror, l=$Q_1$] (6,2)
        (r1.C) to[R, l=$R_1$, i<_=$I_{IN}$] ($(r1.C)+(0,2)$) node[vcc] {$V_{CC}$}
        (r1.E) node[ground] {}
        (r1.B) |- (r1.C)

        (8,0) to[Tnpn, name=r2, l=$Q_2$] (8,2)
        (r2.B) -- (r1.B)
        (r2.E) to[R, l=$R_2$] ($(r2.E)-(0,2)$) node[ground] {}
        ($(r2.C)+(0,0.5)$) to[short, i=$I_{OUT}$] (r2.C)
        ;
    \end{tikzpicture}
    \caption{On the left, a simple BJT current source. On the right, a Widlar
    source. Note that these circuits can also be implemented using MOS transistors.}
    \label{fig:current-mirror-widlar}
\end{figure}

\subsubsection{Widlar source}
A Widlar source (see the right part of figure~\ref{fig:current-mirror-widlar})
improves the supply voltage sensitivity of its output current.
$I_{OUT}$ is given by\footnote{This is easy to derive knowing that the collector current
$I_C = I_s(e^{V_{BE}/V_T}-1) \approx I_se^{V_{BE}/V_T}$.}
\[ I_{OUT} \approx \frac{V_T}{R_2}\ln\frac{I_{IN}}{I_{OUT}}. \]
To compute $S^{I_{OUT}}_{V_{CC}}$, we take the derivative with respect to $V_{CC}$
of each side of the above equation
\[
    \fpart{I_{OUT}}{V_{CC}} = \frac{V_T}{R_2}\fpart{}{V_{CC}}\left(\ln{
    \frac{I_{IN}}{I_{OUT}}}\right).
\]
Developing this expression leads to
\[ S^{I_{OUT}}_{V_{CC}} = \frac{1}{1+\frac{I_{OUT}R_2}{V_T}}S^{I_{IN}}_{V_{CC}} \]
where $S^{I_{IN}}_{V_{CC}} \approx 1$.
\begin{myexem}
    Consider a Widlar source with $I_{IN} = \SI{1}{\milli\ampere}$, $I_{OUT} =
    \SI{5}{\micro\ampere}$ and $R_2 = \SI{27.4}{\kilo\ohm}$. In this case,
    $S^{I_{OUT}}_{V_{CC}} \approx 0.16$, this is already 6 times better than the
    basic current mirror. Generally speaking, a Widlar source is 5 to 10 times
    less sensitive to supply voltage than a current mirror.
\end{myexem}

\subsection{Other voltage standards}
Even though Widlar current sources offer better performance than simple current
mirrors in term of current sensitivity to supply voltage, they are still not adequate
for many types of analog circuits. Much lower sensitivity can be obtained by causing
the bias currents in the circuits to depend on a voltage standard other than the
supply voltage, for example, on $V_{BE}$ or $V_{TH}$, $V_T$ or the breakdown
voltage of a Zener diode. Each of these standards can be used to reduce supply
sensitivity. The drawback of the three first afermentioned standards, however, is
that they are temperature dependent:
\begin{itemize}
    \item $V_{BE}$ and $V_{TH}$ have a temperature coefficient of $\approx 1-\SI{2}
    {\milli\volt\per\degree}$ ;
    \item $V_T$ has a temperature coefficient of $k/q \approx \SI{86}{\micro\volt\per
    \degree}$.
\end{itemize}
The Zener diode has the disavantage that at least 7 to \SI{10}{\volt} of supply
voltage are required because standard integrated-circuit processes produce a
minimum breakdown voltage of about \SI{6}{\volt}.

\subsubsection{$V_{BE}$ or $V_{TH}$ reference}
The schematic of a base-emitter referenced current source is presented in
figure~\ref{fig:vbe-ref-current-source}. Assuming that transistor $Q_2$
supply enough current into $R_2$ so that a current flow in $Q_1$, we have
\[ V_{BE,1} = V_T\ln{\frac{I_{IN}}{I_{S1}}}. \]
If we neglect base currents, $I_{OUT}$ is equal to the current flowing through
$R_2$, that is
\[ I_{OUT} = \frac{V_{BE,1}}{R_2} = \frac{V_T}{R_2}\ln{\frac{I_{IN}}{I_{S1}}}. \]
Again, differentiating w.r.t $V_{CC}$ on both sides and rearranging a bit, we get
\[ S^{I_{OUT}}_{V_{CC}} = \frac{V_T}{I_{OUT}R_2}S^{I_{IN}}_{V_{CC}}
= \frac{V_T}{V_{BE(on)}}S^{I_{OUT}}_{V_{CC}}. \]
Assuming that $V_{CC} \gg 2V_{BE(on)}$, we have again that $S^{I_{OUT}}_{V_{CC}}
\approx 1$. With $V_{BE(on)} = \SI{0.7}{\volt}$,
\[ S^{I_{OUT}}_{V_{CC}} \approx 0.037 \]
which is again more than 4 times better than what we had with Widlar sources.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture} \draw
        (0,0) to[Tnpn, name=r1, mirror, l=$Q_1$] (0,2)
        (r1.C) to[R, l=$R_1$, i<=$I_{IN}$] ($(r1.C)+(0,3)$) node[vcc] {$V_{CC}$}
        (r1.E) -- (0,-1) -- (1,-1) node[ground] {} -- (2,-1)
        to[R, l=$R_2$] (2,1)
        (r1.B) -- (2,1)
        to[Tnpn, name=r2, l=$Q_2$] (2,3)
        (r2.B) -- ($(r1.C)+(0,0.22)$)
        ($(r2.C)+(0,0.5)$) to[short, i=$I_{OUT}$] (r2.C)
        ;
    \end{tikzpicture}
    \caption{Base-emitter referenced current source. The same circuit can be
    implemented using MOS transistors (in this case it's called a threshold-referenced
    current course.}
    \label{fig:vbe-ref-current-source}
\end{figure}

\subsubsection{$V_{BE}$ or $V_{TH}$ self-biasing reference}
Power supply sensitivity can be greatly reduced by the use of self-biasing
circuits. The principle behind this technique is illustrated in
figure~\ref{fig:self-biasing-principle}. In a nutshell, the idea is to put
two constraints on the currents:
\begin{enumerate}
    \item Assuming the current mirror has unity gain, $I_{IN} = I_{OUT}$ ;
    \item The current source puts another constraints on $I_{IN}$ and
    $I_{OUT}$ of the same for as the one imposed by the base-emitter reference
    current source for example.
\end{enumerate}
The operating point must then be at the intersection of the two constraints
(see right part of figure~\ref{fig:self-biasing-principle}). There always
exists two possible operating point, a ideally unstable one when no current
is flowing in the circuit (point $B$) and a stable one (point $A$). In
practice, however, point $B$ is not unstable and the start-up circuit must
be used to avoid the circuit to stay at this point.

\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{figures/self-biasing-principle.png}
    \caption{Principle of a self-biased reference and determination of the
    operating point.}
    \label{fig:self-biasing-principle}
\end{figure}

\part{DAC}

\part{ADC}

\nocite{*}
\bibliographystyle{plain}
\bibliography{biblio}

\end{document}
